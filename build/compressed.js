// title: Whitecane
// author: Misteki
// desc: TIC-80 test
// script: js
// input: mouse

function log(i){var t=""
Object.keys(i).forEach(function(e){t=t+e+":"+i[e]+", "}),trace("{"+t+"}")}function isPointInRect(i,t,e,n,o,r){return i>=e&&i<e+o&&t>=n&&t<n+r}function areCollidingFull(i,t,e,n){return Math.floor(i)===Math.floor(e)&&Math.floor(t)===Math.floor(n)}function initScene(i){var t={top:3,bottom:1,left:2,right:2},e={6:{type:"BEND",directions:{up:!0,right:!1}},8:{type:"BEND",directions:{up:!0,right:!0}},10:{type:"BEND",directions:{up:!1,right:!1}},12:{type:"BEND",directions:{up:!1,right:!0}},64:{type:"HOME",color:"GREEN"},66:{type:"HOME",color:"BLUE"},68:{type:"HOME",color:"ORANGE"},76:{type:"SPAWNER"}}
for(x=t.left;x<30-t.right;x++)for(y=t.top;y<17-t.bottom;y++){var n=e[mget(x,y)]
if(n)switch(n.type){case"BEND":i.bends.push({x:x*TILE_SIZE,y:n.directions.up?y*TILE_SIZE+16:y*TILE_SIZE-16,directions:n.directions,type:n.type}),i.bends.push({x:n.directions.right?x*TILE_SIZE-16:x*TILE_SIZE+16,y:y*TILE_SIZE,directions:n.directions,type:n.type})}}i.barriers=i.barriers.map(function(i){return i.animationId=i.directions[0],i.animationFrameIndex=0,i.animationSpeed=0,i.animationTimestamp=0,i.bends=i.directions.map(function(t){switch(t){case"RIGHT":return{x:i.x+16,y:i.y,directions:{right:!1},type:"BEND"}
case"LEFT":return{x:i.x-16,y:i.y,directions:{right:!0},type:"BEND"}
case"UP":return{x:i.x,y:i.y-16,directions:{up:!1},type:"BEND"}
case"DOWN":return{x:i.x,y:i.y+16,directions:{up:!1},type:"BEND"}}}),i})}function getInput(i){var t=mouse(),e=time()
i.x=t[0],i.y=t[1],i.p=t[2]&&(0===i.lastClickStamp||e-i.lastClickStamp>50)?1:0,i.lastClickStamp=t[2]?e:i.lastClickStamp}function update(i,t,e){updateCursorPosition(i,t.cursor),onBarrierClick(i,t.barriers),move(t.walkers,t.barriers,t.bends,e),animate(t,e)}function updateCursorPosition(i,t){t.x=16*Math.floor(i.x/16),t.y=16*Math.floor((i.y+8)/16)-8}function onBarrierClick(i,t){t.forEach(function(t){if(i.p&&isPointInRect(i.x,i.y,t.x,t.y,TILE_SCALE*TILE_SIZE,TILE_SCALE*TILE_SIZE)){var e=t.directions.indexOf(t.animationId)
t.animationId=e+1<t.directions.length?t.directions[e+1]:t.directions[0]}})}function move(i,t,e,n){i.forEach(function(i){var o=i.x+i.velocityX*n,r=i.y+i.velocityY*n
e.forEach(function(t){areCollidingFull(o+16*(i.velocityX?i.velocityX<0?-1:1:0),r+16*(i.velocityY?i.velocityY<0?-1:1:0),t.x,t.y)?0!==i.velocityX?(i.velocityY=i.speed*(t.directions.up?-1:1),i.velocityX=0,i.animationId=t.directions.up?"UP":"DOWN",i.y=r):0!==i.velocityY&&(i.velocityX=i.speed*(t.directions.right?1:-1),i.velocityY=0,i.animationId=t.directions.right?"RIGHT":"LEFT",i.x=o):(i.x=o,i.y=r)}),t.forEach(function(t){areCollidingFull(t.x,t.y,i.x,i.y)&&(trace("ola"),t.bends.forEach(function(t){areCollidingFull(o+16*(i.velocityX?i.velocityX<0?-1:1:0),r+16*(i.velocityY?i.velocityY<0?-1:1:0),t.x,t.y)?0!==i.velocityX?(i.velocityY=i.speed*(t.directions.up?-1:1),i.velocityX=0,i.animationId=t.directions.up?"UP":"DOWN",i.y=r):0!==i.velocityY&&(i.velocityX=i.speed*(t.directions.right?1:-1),i.velocityY=0,i.animationId=t.directions.right?"RIGHT":"LEFT",i.x=o):(i.x=o,i.y=r)}))})})}function animateEntity(i,t){var e=ANIMATIONS[i.type][i.animationId],n=100*t,o=i.animationTimestamp+n>=i.animationSpeed
i.animationFrameIndex=o?i.animationFrameIndex+1<e.length?i.animationFrameIndex+1:0:i.animationFrameIndex,i.animationTimestamp=o?0:i.animationTimestamp+n,i.sprite=e[i.animationFrameIndex]}function animate(i,t){i.walkers.forEach(function(i){animateEntity(i,t)}),i.barriers.forEach(function(i){animateEntity(i,t)})}function draw(i){map(i.tilemap.x,i.tilemap.y),i.walkers.forEach(function(i){spr(i.sprite,i.x,i.y-8,0,1,0,0,TILE_SCALE,TILE_SCALE)}),i.barriers.forEach(function(i){spr(i.sprite,i.x,i.y,0,1,0,0,TILE_SCALE,TILE_SCALE)})
var t=44
i.barriers.forEach(function(e){isPointInRect(i.cursor.x,i.cursor.y,e.x,e.y,TILE_SCALE,TILE_SCALE)&&(t=46)}),spr(t,i.cursor.x,i.cursor.y,0,1,0,0,TILE_SCALE,TILE_SCALE)}function TIC(){var i=time()
delta=(i-t)/1e3,t=i,getInput(mouseData),update(mouseData,scene,delta),draw(scene)}var TILE_SCALE=2,TILE_SIZE=8,ANIMATIONS={WALKER:{DOWN:[288,290,288,292],UP:[294,296,294,298],RIGHT:[300,302,300,320],LEFT:[322,324,322,326]},BARRIER:{DOWN:[42],RIGHT:[40]}},t=0,delta=0,mouseData={x:0,y:0,p:0,lastClickStamp:0},scene={tilemap:{x:0,y:0},walkers:[{type:"WALKER",speed:30,x:32,y:40,velocityX:30,velocityY:0,sprite:0,animationId:"RIGHT",animationFrameIndex:0,animationSpeed:11,animationTimestamp:0}],barriers:[{type:"BARRIER",x:112,y:40,directions:["RIGHT","DOWN"]}],bends:[],cursor:{x:0,y:0,sprite:44}}
initScene(scene)
